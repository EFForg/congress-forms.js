/*
 *  Contact Congress - v0.0.1
 *  A widget for building forms for contacting congress.
 *  https://github.com/efforg/contact-congress.js
 *
 *  Made by Thomas Davis
 *  Under TBD License
 */
!function(a){function b(b,e){this.element=b,this.settings=a.extend({},d,e),this._defaults=d,this._name=c,this.init()}var c="contactCongress",d={contactCongressServer:"http://ec2-54-215-28-56.us-west-1.compute.amazonaws.com:3000",labels:!0,bioguide_ids:[]};b.prototype={init:function(){var b=a("<form/>").addClass("form");this.retrieveFormElements(b)},retrieveFormElements:function(b){var c=this;a.ajax({url:c.settings.contactCongressServer+"/retrieve-form-elements",type:"post",data:{bio_ids:this.settings.bioguide_ids},success:function(a){var d=c.groupCommonFields(a);c.generateForm(d,b)}})},generateForm:function(b,c){var d=this,e=b.common_fields,f=a("<fieldset/>");f.append("<legend>Common Fields</legend>"),a.each(e,function(a,b){var c=d.generateFormGroup(b);f.append(c)}),c.append(f),a.each(b.individual_fields,function(b,e){var f=a("<fieldset/>");f.append("<legend>"+b+"</legend>"),a.each(e,function(a,b){var c=d.generateFormGroup(b);f.append(c)}),c.append(f)});var g=a('<input type="submit"/>');c.append(g),a(d.element).append(c)},generateFormGroup:function(b){var c=this,d=c._format_label(b.value),e=b.value,f=a("<div/>").addClass("form-group");if(c.settings.labels){var g=a("<label/>").text(d).attr("for",e);f.append(g)}var h=a('<input type="text" />').addClass("form-control").attr("placeholder",d);return f.append(h),f},groupCommonFields:function(b){var c=this,d={common_fields:[],individual_fields:{}},e=c.settings.bioguide_ids.length;if(e>1){var f={};a.each(this.settings.bioguide_ids,function(c,d){var e=b[d];a.each(e.required_actions,function(a,b){"undefined"==typeof f[b.value]?f[b.value]=[d]:f[b.value].push(d)})});a.each(f,function(b,c){c.length>1?d.common_fields.push({value:b}):a.each(c,function(a,c){"undefined"==typeof d.individual_fields[c]?d.individual_fields[c]=[{value:b}]:d.individual_fields[c].push({value:b})})})}else d.common_fields=b[c.settings.bioguide_ids[0]].required_actions;return console.log(d),d},_format_label:function(b){var c=b.replace("$","").replace("_"," ").split(" ");return a.map(c,function(a){return a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()}).join(" ")}},a.fn[c]=function(d){return this.each(function(){a.data(this,"plugin_"+c)||a.data(this,"plugin_"+c,new b(this,d))}),this}}(jQuery,window,document);