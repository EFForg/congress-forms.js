/*
 *  Congress Forms - v0.0.1
 *  A widget for building forms for contacting congress.
 *  https://github.com/efforg/congress-forms.js
 *
 *  Made by Thomas Davis
 *  Under TBD License
 */
!function(a){function b(b,e){this.element=b,this.settings=a.extend({},d,e),this._defaults=d,this._name=c,this.init()}var c="congressForms",d={contactCongressServer:"https://congressforms.eff.org",labels:!0,debug:!1,values:{},bioguide_ids:[],labelClasses:"",textInputClasses:"form-control",textareaClasses:"form-control",formClasses:"form",selectInputClasses:"form-control",formGroupClasses:"form-group",legislatorLabelClasses:"",submitClasses:"btn",success:function(){},onRender:function(){},onLegislatorSubmit:function(){},onLegislatorCaptcha:function(){},onLegislatorCaptchaSubmit:function(){},onLegislatorCaptchaSuccess:function(){},onLegislatorCaptchaError:function(){},onLegislatorSuccess:function(){},onLegislatorError:function(){},error:function(){}};b.prototype={completedEmails:0,legislatorCount:0,init:function(){var b=this,d=a("<form/>").addClass(this.settings.formClasses);this.retrieveFormElements(d),a(d).on("submit",this.submitForm.bind(this)),a("body").on("click","."+c+"-captcha-button",function(d){var e=a(d.currentTarget).parents("."+c+"-captcha-container").find("."+c+"-captcha");b.submitCaptchaForm(e)}),a("body").on("keypress","."+c+"-captcha",function(c){if(13==c.which){var d=a(c.currentTarget);b.submitCaptchaForm(d)}})},retrieveFormElements:function(b){var c=this;a.ajax({url:c.settings.contactCongressServer+"/retrieve-form-elements",type:"post",data:{bio_ids:this.settings.bioguide_ids},success:function(a){var d=c.groupCommonFields(a);c.generateForm(d,b)}})},submitForm:function(b){var d=this,e=a(b.currentTarget),f=a("#"+c+"-common-fields",e),g=f.serializeObject();if(a("."+c+"-legislator-fields").length>0)a.each(a("."+c+"-legislator-fields"),function(b,c){var e=a(c).attr("data-legislator-id"),f=a(c).serializeObject();console.log(e,c,f);var i=a.extend({},g,f),j=d.generateUID();d.settings.onLegislatorSubmit(e,a(c)),d.settings.debug?setTimeout(function(){var b=Math.ceil(3*Math.random());switch(b){case 1:d.settings.onLegislatorSuccess(e,a(c));break;case 2:d.settings.onLegislatorError(e,a(c));break;case 3:var f=d.generateCaptchaForm("http://i.imgur.com/BG2yMUp.png",e,j);a(c).append(f),d.settings.onLegislatorCaptcha(e,a(c))}},500):a.ajax({url:d.settings.contactCongressServer+"/fill-out-form",type:"post",xhrFields:{withCredentials:!0},data:{bio_id:e,fields:i},success:function(b){if(console.log("what",b),"success"===b.status)d.settings.onLegislatorSuccess(e,a(c));else if("captcha_needed"===b.status){var f=d.generateCaptchaForm(b.url,e,b.uid);a(c).append(f),d.settings.onLegislatorCaptcha(h,a(c))}else d.settings.onLegislatorError(e,a(c))}})});else{var h=d.settings.bioguide_ids[0],i=d.generateUID();d.settings.debug?setTimeout(function(){var b=Math.ceil(3*Math.random());switch(b){case 1:d.settings.onLegislatorSuccess(h,a(f));break;case 2:d.settings.onLegislatorError(h,a(f));break;case 3:var c=d.generateCaptchaForm("http://i.imgur.com/BG2yMUp.png",h,i);a(f).append(c),d.settings.onLegislatorCaptcha(h,a(f))}},500):a.ajax({url:d.settings.contactCongressServer+"/fill-out-form",type:"post",data:{bio_id:h,fields:g},success:function(b){if(console.log("hey",b),"success"===b.status)d.settings.onLegislatorSuccess(h,a(f));else if("captcha_needed"===b.status){alert(b.uid);var c=d.generateCaptchaForm(b.url,h,b.uid);a(f).append(c),d.settings.onLegislatorCaptcha(h,a(f))}else d.settings.onLegislatorError(h,a(f))}})}return a("input, textarea, select, button",e).attr("disabled","disabled"),!1},generateForm:function(b,d){var e=this,f=b.common_fields,g=a("<fieldset/>").attr("id",c+"-common-fields");if(a.each(f,function(a,b){var c=e.generateFormGroup(b);g.append(c)}),d.append(g),a.each(b.individual_fields,function(b,f){var g=a("<fieldset/>").attr("data-legislator-id",b).addClass(c+"-legislator-fields");g.append(a("<label>").text(b).addClass(e.settings.legislatorLabelClasses)),a.each(f,function(a,b){var c=e.generateFormGroup(b);g.append(c)}),d.append(g)}),1===e.settings.bioguide_ids.length){var h=e.settings.bioguide_ids[0];g.attr("data-legislator-id",h).addClass(c+"-legislator-fields").prepend(a("<label>").text(h).addClass(e.settings.legislatorLabelClasses))}var i=a('<input type="submit"/>');i.addClass(e.settings.submitClasses),d.append(i),a(e.element).append(d),e.settings.onRender()},submitCaptchaForm:function(b){var c=this,d=a(b).val(),e=a(b).attr("data-captcha-uid"),f=a(b).attr("data-captcha-legislator-id"),g=a('fieldset[data-legislator-id="'+f+'"]');if(c.settings.onLegislatorCaptchaSubmit(f,a(g)),c.settings.debug){var h=Math.ceil(2*Math.random());setTimeout(function(){switch(h){case 1:c.settings.onLegislatorCaptchaSuccess(f,a(g));break;case 2:c.settings.onLegislatorCaptchaError(f,a(g))}},1500)}else a.ajax({url:c.settings.contactCongressServer+"/fill-out-captcha",type:"post",xhrFields:{withCredentials:!0},data:{uid:e,answer:d},success:function(b){"success"===b.status?c.settings.onLegislatorCaptchaSuccess(f,a(g)):c.settings.onLegislatorCaptchaError(f,a(g))}});return console.log("answer",d,e,f,g),!1},generateCaptchaForm:function(b,d,e){var f=a("<div/>").addClass(c+"-captcha-container"),g=a("<label/>").text("Type the text in the image to send your message").addClass(c+"-captcha-label");f.append(g);var h=a("<img/>").attr("src",b).addClass(c+"-captcha-image");f.append(h);var i=a("<input/>").attr("type","text").addClass("form-control "+c+"-captcha").attr("data-captcha-legislator-id",d).attr("data-captcha-uid",e);f.append(i);var j=a("<button>").attr("type","button").addClass("btn btn-primary "+c+"-captcha-button").text("Submit Captcha");return f.append(j),f},generateFormGroup:function(b){var c=this,d=c._format_label(b.value),e=b.value,f=a("<div/>").addClass(this.settings.formGroupClasses);if(c.settings.labels){var g=a("<label/>").text(d).attr("for",e).addClass(this.settings.labelClasses);f.append(g)}if(null!==b.options_hash||"$ADDRESS_STATE_POSTAL_ABBREV"===b.value||"$ADDRESS_STATE"===b.value){var h=a("<select/>");if(h.addClass(c.settings.selectInputClasses),b.options=[],("$ADDRESS_STATE_POSTAL_ABBREV"===b.value||"$ADDRESS_STATE"===b.value)&&(b.options=c._data.STATES,delete b.options_hash),b.options_hash&&a.isArray(b.options_hash)&&"object"==typeof b.options_hash[0]){var i={};a.each(b.options_hash,function(b){a.each(b,function(a,b){i[b]=a})}),b.options_hash=i}b.options_hash&&!a.isArray(b.options_hash)&&(a.each(b.options_hash,function(a,c){b.options.push({name:a,value:c})}),delete b.options_hash),"string"!=typeof b.options_hash&&b.options_hash||(b.options_hash=[]),a.each(b.options_hash,function(b,c){var d=a("<option/>").attr("value",c).text(c);h.append(d)}),a.each(b.options,function(b,c){var d=a("<option/>").attr("value",c.value).text(c.name);h.append(d)})}else if("$MESSAGE"===e){var h=a("<textarea />").attr("id",e).attr("placeholder",d);h.addClass(c.settings.textareaClasses)}else{var h=a('<input type="text" />').attr("placeholder",d);h.addClass(c.settings.textInputClasses)}c.settings.values&&"undefined"!=typeof c.settings.values[e]&&h.val(c.settings.values[e]),h.attr("id",e).attr("name",e),h.attr("required","required");var j=c.fieldData;return j[e]&&a.each(j[e],function(a,b){h.attr(a,b)}),f.append(h),f},fieldData:{$EMAIL:{type:"email"},$NAME_FIRST:{maxlength:"20"},$NAME_LAST:{maxlength:"20"},$ADDRESS_ZIP5:{pattern:"[0-9]{5}"}},groupCommonFields:function(b){var c=this,d={common_fields:[],individual_fields:{}},e=c.settings.bioguide_ids.length;if(e>1){var f={};a.each(this.settings.bioguide_ids,function(c,e){var g=b[e];a.each(g.required_actions,function(a,b){null===b.options_hash?"undefined"==typeof f[b.value]?f[b.value]=[e]:f[b.value].push(e):"undefined"==typeof d.individual_fields[e]?d.individual_fields[e]=[b]:d.individual_fields[e].push(b)})});a.each(f,function(b,c){c.length>1?d.common_fields.push({value:b,options_hash:null}):a.each(c,function(a,c){"undefined"==typeof d.individual_fields[c]?d.individual_fields[c]=[{value:b,options_hash:null}]:d.individual_fields[c].push({value:b,options_hash:null})})})}else d.common_fields=b[c.settings.bioguide_ids[0]].required_actions;return d},_format_label:function(b){var c={$NAME_LAST:"Last Name",$NAME_FIRST:"First Name"};if("undefined"!=typeof c[b])return c[b];var d=b.replace("$","").replace("_"," ").split(" ");return a.map(d,function(a){return a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()}).join(" ")},generateUID:function(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;10>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a},_data:{STATES:[{name:"ALABAMA",value:"AL"},{name:"ALASKA",value:"AK"},{name:"AMERICAN SAMOA",value:"AS"},{name:"ARIZONA",value:"AZ"},{name:"ARKANSAS",value:"AR"},{name:"CALIFORNIA",value:"CA"},{name:"COLORADO",value:"CO"},{name:"CONNECTICUT",value:"CT"},{name:"DELAWARE",value:"DE"},{name:"DISTRICT OF COLUMBIA",value:"DC"},{name:"FEDERATED STATES OF MICRONESIA",value:"FM"},{name:"FLORIDA",value:"FL"},{name:"GEORGIA",value:"GA"},{name:"GUAM",value:"GU"},{name:"HAWAII",value:"HI"},{name:"IDAHO",value:"ID"},{name:"ILLINOIS",value:"IL"},{name:"INDIANA",value:"IN"},{name:"IOWA",value:"IA"},{name:"KANSAS",value:"KS"},{name:"KENTUCKY",value:"KY"},{name:"LOUISIANA",value:"LA"},{name:"MAINE",value:"ME"},{name:"MARSHALL ISLANDS",value:"MH"},{name:"MARYLAND",value:"MD"},{name:"MASSACHUSETTS",value:"MA"},{name:"MICHIGAN",value:"MI"},{name:"MINNESOTA",value:"MN"},{name:"MISSISSIPPI",value:"MS"},{name:"MISSOURI",value:"MO"},{name:"MONTANA",value:"MT"},{name:"NEBRASKA",value:"NE"},{name:"NEVADA",value:"NV"},{name:"NEW HAMPSHIRE",value:"NH"},{name:"NEW JERSEY",value:"NJ"},{name:"NEW MEXICO",value:"NM"},{name:"NEW YORK",value:"NY"},{name:"NORTH CAROLINA",value:"NC"},{name:"NORTH DAKOTA",value:"ND"},{name:"NORTHERN MARIANA ISLANDS",value:"MP"},{name:"OHIO",value:"OH"},{name:"OKLAHOMA",value:"OK"},{name:"OREGON",value:"OR"},{name:"PALAU",value:"PW"},{name:"PENNSYLVANIA",value:"PA"},{name:"PUERTO RICO",value:"PR"},{name:"RHODE ISLAND",value:"RI"},{name:"SOUTH CAROLINA",value:"SC"},{name:"SOUTH DAKOTA",value:"SD"},{name:"TENNESSEE",value:"TN"},{name:"TEXAS",value:"TX"},{name:"UTAH",value:"UT"},{name:"VERMONT",value:"VT"},{name:"VIRGIN ISLANDS",value:"VI"},{name:"VIRGINIA",value:"VA"},{name:"WASHINGTON",value:"WA"},{name:"WEST VIRGINIA",value:"WV"},{name:"WISCONSIN",value:"WI"},{name:"WYOMING",value:"WY"}]}},a.fn.serializeObject=function(){var b={},c=this.serializeArray();return a.each(c,function(){b[this.name]?(b[this.name].push||(b[this.name]=[b[this.name]]),b[this.name].push(this.value||"")):b[this.name]=this.value||""}),b},a.fn[c]=function(d){return this.each(function(){a.data(this,"plugin_"+c)||a.data(this,"plugin_"+c,new b(this,d))}),this}}(jQuery,window,document);